name: Development workflow

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

# Here the environment variable is declared in workflow level
env:
  PROJECT_NAME: My_Project_Name
  PROJECT_FOLDER: ${{ github.action_path }}
  ORCH_SECRET:  ${{ secrets.UIPATHCLIENTSECRET }} #create in repository
  ORCH_CLIENT_ID: ${{ secrets.UIPATHCLIENTID }} #create in repository
  GH_TOKEN: ${{ github.token }} 


jobs:
  cleaner:
    runs-on:  ubuntu-latest
    steps:
      - name: Runner workspace path
        run: |
          echo "Cleaning up previous run"
          rm -rf "$ {{ github.workspace }}"

  analyze-project:
    needs: cleaner
    runs-on: windows-latest
    steps:
      - name: Check out repository code 
        uses: actions/checkout@v4
      - name: Analyze project for errors  
        shell:  pwsh
        run:  ${{ github.workspace }}\scripts\tools\tools\uipcli.exe package analyze "${{ github.workspace }}\project.json" --analyzerTraceLevel "Error"  --resultPath "${{ github.workspace }}\validate.json" --orchestratorUrl "https://cloud.uipath.com/" --orchestratorTenant "dev" --orchestratorApplicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Monitoring OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Administration OR.Analytics OR.Audit OR.Hypervisor OR.License OR.Machines OR.ML OR.Queues OR.Robots OR.Settings OR.Tasks OR.TestDataQueues OR.Users OR.Webhooks" --orchestratorAccountForApp "myriadgeneticsinc" --orchestratorApplicationId ${{ secrets.UIPATHCLIENTID }} --orchestratorApplicationSecret ${{ secrets.UIPATHCLIENTSECRET }} --orchestratorFolder "BLG-ARX"
      - name: Upload Analyzer File
        uses: actions/upload-artifact@v4
        with: 
          name: ValidationFile
          path: validate.json
      
  build-uipath-nuget-package:
    needs: analyze-project
    runs-on: windows-latest
    steps:
      - name: Check out repository code 
        uses: actions/checkout@v4
      - name: Build nuget package 
        shell:  pwsh
        run:  |
          ${{ github.workspace }}\scripts\tools\tools\uipcli.exe package pack "${{ github.workspace }}\project.json" -o "${{ github.workspace }}\package" --autoVersion --outputType "Tests" --libraryOrchestratorUrl "https://cloud.uipath.com/" --libraryOrchestratorTenant "dev" --libraryOrchestratorApplicationId ${{ secrets.UIPATHCLIENTID }} --libraryOrchestratorApplicationSecret ${{ secrets.UIPATHCLIENTSECRET }} --libraryOrchestratorAccountForApp "myriadgeneticsinc" --libraryOrchestratorApplicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Monitoring OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Administration OR.Analytics OR.Audit OR.Hypervisor OR.License OR.Machines OR.ML OR.Queues OR.Robots OR.Settings OR.Tasks OR.TestDataQueues OR.Users OR.Webhooks" --libraryOrchestratorFolder "BLG-ARX"
          ls ${{ github.workspace }}\package
      - name: Upload UiPath Artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: Artifacts
          path: |
            package/*.*
            scripts/*.ps1

  publish-uipath-nuget-package:
    needs:  build-uipath-nuget-package
    runs-on:  windows-latest
    steps:
      - name: Download UiPath Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Artifacts
      - name: Publish Nuget Package to DEV
        shell:  pwsh
        run:  ${{ github.workspace }}\scripts\PublishPackageToDev.ps1 ${{ github.workspace }}\package\BLG-ARX-GetWork*.nupkg  #Dept-BU-ProcessName

  add-process-to-folder:
    needs:   publish-uipath-nuget-package
    runs-on:  windows-latest
    steps:
      - name: Download UiPath Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Artifacts
      - name: Add Process to Folder
        shell:  pwsh
        run:  ${{ github.workspace }}\scripts\AddProcessToDev.ps1

  test-uipath-published-package:
    needs:  add-process-to-folder
    runs-on:  windows-latest
    steps:
      - name: Download UiPath Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Artifacts
      - name: Get Test Cases
        shell:  pwsh
        run:  ${{ github.workspace }}\scripts\GetTests.ps1 
      - name: Upload Test Cases
        uses: actions/upload-artifact@v4
        with: 
          name: Tests
          path: TestReport.csv
      - name: Download Test Cases
        uses: actions/download-artifact@v4
        with: 
          name: Tests
      - name: Run Test Cases
        shell:  pwsh
        run:  ${{ github.workspace }}\scripts\StartTests.ps1 
